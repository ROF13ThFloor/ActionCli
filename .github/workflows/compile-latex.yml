name: Compile LaTeX with Bibliography

on:
  push:
    branches:
      - main  # Trigger on push to the 'main' branch
  pull_request:  # Trigger on pull request

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde
      with: 
        egress-policy: audit
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install TeX Live
      run: sudo apt-get update && sudo apt-get install -y texlive-full
      
    - name: Set up output directory
      run: mkdir -p output && chmod -R u+w output
      
    - name: Compile LaTeX (1st pass)
      run: pdflatex -interaction=nonstopmode -halt-on-error -output-directory=output main.tex

    - name: Compile Bibliography
      run: bibtex output/main.aux  # Change to 'biber output/main' if using biber

    - name: Compile LaTeX (2nd and 3rd pass)
      run: |
        pdflatex -interaction=nonstopmode -halt-on-error -output-directory=output main.tex
        pdflatex -interaction=nonstopmode -halt-on-error -output-directory=output main.tex

    - name: Clean up temporary files
      run: rm output/*.aux output/*.bbl output/*.blg output/*.log output/*.out output/*.toc

    - name: Upload PDF
      uses: actions/upload-artifact@v3
      with:
        name: compiled-pdf
        path: output/main.pdf
